---
title: 力争代码被有效测试过
date: 2018-11-07 17:08:35
categories: 测试
tags:
  - Ruby
---
> 使用模糊测试和属性测试工具，帮助测试代码的快乐路径和异常路径。

在测试中，一个常犯的错误是我们只写快乐路径 `happy path` 测试。这是刚写完开发代码之后写测试时常见的情况。快乐路径测试，是指被测代码的前提条件都被满足的前提下，仅测试有效出入的测试方法。

有时候我们可能没有验证输入的合法性，而且中数据库中也没有添加不可为空的约束。快乐路径测试是有价值的，但是这不足以帮我们发现所有的 `bug`，因为制定的测试只测试了我们期望代码该做的事。

解决这个问题的一种方法是加入异常路径 `exception path` 测试，输入各种各样的值并保证代码的每一个分支都被执行过。例如模糊测试 `fuzz testing` 和属性测试 `property testing`。

这两种测试既互有联系，但又有不同的目的。基本思想都是，给我们的代码输入大量不同类型的数据，保证我们的代码依然能够正常工作。一般来说，模糊测试主要是应用于安全领域。向一个程序或者特定的方法输入大量随机的数据，是找出程序崩溃或暴露安全漏洞的一种非常好的方法。

采用模糊测试方法，我们的关注点从测试结果是通过还是失败，转移到是否能找到程序崩溃或者是异常问题上。这个过程通常需要一个随机值的发生器 `generator` 和我们需要测试的代码片段。举个例子，假如我们想知道 `URL::HTTP::build` 方法是否会在输入完全随机的无效主机名 `host name` 后崩溃？针对这个问题我们可以使用 `Ruby` 模糊测试库中的一个名为 `FuzzBert` 的 `Gem`。

```ruby
require('fuzzbert')
require('uri')

fuzz('URI::HTTP::build') do
  data("random server names") do
    FuzzBert::Generators.random
  end

  deploy do |data|
    URI::HTTP::build(host: data, path: '/')
  end
end
```

模糊测试虽说非常有趣，但并不适合日常使用。部分原因是，像 `FuzzBert` 这样的工具会持续不断地运行测试，除非你手动终止。为了让模糊测试更加高效，有时需要它连续运行好几天。`FuzzBert` 提供了配置选项，允许我们设置模糊测试运行的时间，不过测试运行的时间越长，你将越有信心相信代码里没有让系统崩溃的 `bug` 存在。

与模糊测试相似，属性测试也使用随机输入来测试你的代码，但所添加测试的期望是确定的。属性测试相对来说，显得更加实际，因为测试是有限的，而且可以与自动化单元测试一起运行。我们可以使用 `MrProper` 进行属性测试。

```ruby
require('mrproper')

properties('Version') do
  data([Integer, Integer, Integer])

  property("new(str).to_s == str") do |data|
    str = data.join('.')
    assert_equal(str, Version.new(str),to_s)
  end
end
```

> 测试覆盖率工具会给你一种虚假的安全感，因为被执行过的代码不代表这行代码是正确的。

代码覆盖率工具可以生成测试报告，告诉你测试时哪些代码被执行过。`SimpleCov` 能生成非常详细的 `HTML` 报告，涵盖工程中所有的源代码。但是它会给你一种虚假的安全感，因为被执行过的代码不代表这行代码是正确的。你仍然需要确保对执行的代码分支编写了有效的测试。

> 在编写特性的同时就加上测试，会让测试容易很多。

无论使用哪种测试工具，都有一些规则需要你遵守。最重要的一点是，尽早写测试，越早越好。等到接近项目尾声再写为时已晚。一方面，这会让测试脱离现有的项目，成为单独的项目；另一方面，到那时候你可能已经忘了哪些重要的属性需要被测试。所以说，在编写特性的同时就加上测试，会让测试容易很多。

> 这你开始寻找导致 `bug` 的根本原因之前，先写一个针对该 `bug` 的测试。

在寻找导致 `bug` 的根本原因之前，先写一个能够重现这个 `bug` 的测试。重现 `bug` 是修复 `bug` 的第一步，若有专门针对这个 `bug` 的测试，就可以保证在我们修复  `bug` 之后，它不会再次出现。

> 尽可能多地自动化你的测试。

最后，尽可能多地自动化你的测试。有最好的测试，但不去运行他们，那么这些测试也毫无用处。